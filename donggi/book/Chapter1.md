# MSA

##### 일체형 애플리케이션의 한계

- 애플리케이션의 크기가 커질수록 유지보수와 개선이 힘들어짐
- 수직 스케일링의 한계

##### MSA 관련 오픈소스 / 프레임워크

- 스프링 클라우드(동적 서비스 검색, 구성 관리, 분산 추적, 서킷 브레이커)
- 도커(개발 환경과 상용 환경 사이의 간격 최소화)
- 컨테이너 오케스트레이터(쿠버네티스 / 사용 환경에서 컨테이너를 사용하기 위함)
- 서비스 메시(컨테이너 오케스트레이터 보완)

### 마이크로서비스란?

##### MSA의 목표

- 빠르게 개발해 지속적으로 배포 가능해야 함
- 수동 혹은 자동으로 쉽게 스케일링할 수 있어야 함

##### MSA의 기준

- 아무것도 공유하지 않는 아키텍쳐 유지(데이터베이스의 데이터를 공유하지 않음)
- 명확한 인터페이스를 통해 통신(문서화되고 개선되어야 함)
- 개별적인 런타임 프로세스로 배포
- 마이크로서비스 인스턴스는 상태가 없다(모든 인스턴스가 마이크로서비스로 들어오는 요청 처리 가능)

##### MSA의 장점

- 단일 마이크로서비스를 여러 개의 인스턴스로 확장하는 것이 일체형 애플리케이션 활용할 때보다 용이

##### MSA의 단점

- 동기식 통신을 사용하는 다수의 소형 컴포넌트에서는 연쇄 장애 발생 가능
- 다수의 소형 컴포넌트를 최신 상태로 유지하는 것은 어렵다
- 많은 컴포넌트가 처리에 관여하는 요청은 추적하기 어렵다
- 컴포넌트 수준의 하드웨어 지원 사용량 분석도 어렵다
- 다수의 소형 컴포넌트를 수동으로 구성하고 관리하는 건 비용이 많이 들고 오류가 발생하기 쉽다

### 마이크로서비스 디자인 패턴

- 디자인 패턴을 사용해 마이크로서비스의 단점을 완화시키는 방법

##### 서비스 검색 패턴

- 문제점
    - 컨테이너에서 실행되는 인스턴스는 시작하면서 동적 IP 주소를 할당받는다
    - 클라이언트에서 REST API를 호출하는 것이 어렵다
- 해결 방법
    - 현재 사용 가능한 마이크로서비스와 그 인스턴스를 추적하는 새 컴포넌트를 시스템 환경에 구축
    - 마이크로서비스와 인스턴스를 자동으로 등록 및 등록 해지한다
    - 상태가 비정상인 인스턴스를 감지할 수 있어야 함

##### 에지 서버

- 문제점
    - 공개된 마이크로서비스는 악의적인 클라이언트의 요청으로부터 보호해야 한다
- 해결 방법
    - 모든 요청이 거치는 시스템 환경에 새 컴포넌트(에지 서버) 추가
    - 외부 요청을 허용하는 마이크로서비스로만 요청을 라우팅
    - 서비스를 외부로 공개하되 악의적인 요청으로부터 보호(표준 프로토콜 사례를 사용해 신뢰할 수 있는 클라이언트인지 확인)

##### 리액티브 마이크로서비스

- 문제점
    - 블로킹 I/O(RESTful JSON API와 같은 모델)을 사용해 동기식 통신을 구현해왔다.
    - 블로킹 I/O 사용 시 요청 처리하는 동안 운영체제의 스레드를 점유하게 되어 동시 요청 수 증가 / 요청과 관련된 컴포넌트 증가 시 응답 시간 연장 / 서버가 중단되는 문제 발생 가능
- 해결 방법
    - 논블로킹 I/O를 사용한다
    - 비동기 프로그래밍 모델을 사용한다
    - 의존하는 서비스가 중단되더라도 응답할 수 있어야 함

##### 구성 중앙화

- 문제점
    - 실행 중인 모든 마이크로서비스 인스턴스의 구성 정보를 한눈에 보기 어려움
    - 구성을 업데이트하고 관련된 모든 마이크로서비스 인스턴스가 올바르게 업데이트 되게 하는 방법?
- 해결 방법
    - 시스템 환경에 모든 마이크로서비스의 구성 정보를 저장하는 새 컴포넌트를 추가
    - 마이크로서비스 집합에 대한 구성 정보를 한 곳에 저장하고 환경별 설정 지원

##### 로그 분석 중앙화

- 문제점
    - 문제가 발생한 인스턴스를 찾아 로그 파일에 오류 메시지를 쓰도록 하려면?
    - 최종 사용자가 보고한 문제의 로그 메시지를 찾으려면?
- 해결 방법
    - 로그 이벤트를 구조적이고 검색 가능한 형식으로 저장
    - 로그 이벤트를 조회 및 분석하기 위한 그래픽 도구 제공

##### 분산 추적

- 문제점
    - 최종 사용자가 장애에 대한 해결을 요청했을 때 문제를 일으킨 마이크로서비스를 찾으려면?
    - 어떤 문제와 관련된 모든 로그 메시지를 찾으려면?
- 해결 방법
    - 모든 요청 및 메시지에 상관 ID 를 넣는다
    - 상관 ID 검색해 관련 로그 이벤트 검색

##### 서킷 브레이커

- 문제점
    - 동기 방식으로 마이크로서비스 시스템 환경을 구축하면 연쇄 장애가 발생할 여지가 있다
- 해결 방법
    - 해당 서비스의 문제를 감지해 새 요청을 보내지 못하도록 하는 서킷 브레이커 추가
    - 서비스에 문제가 감지되면 시간 초과 무시 후 바로 실패하도록 서킷을 연다

##### 제어 루프

- 문제점
    - 중단되거나 지연된 인스턴스를 수동으로 감지하고 대처하기 어렵다
- 해결 방법
    - 시스템 환경의 상태를 관찰하는 새 컴포넌트를 시스템 환경에 추가
    - 운영자가 지정한 상태와 실제 상태를 지속적으로 관찰

### 블루 그린 배포 방법

##### 중단 배포를 해야하는 이유는?

##### MSA를 도입하면 블루 그린 배포를 할 수 있을까?

##### 블루 그린 배포란?

- 애플리케이션 또는 마이크로서비스의 이전 버전에 있던 사용자 트래픽을 이전 버전과 거의 동일한 새 버전으로 점진적으로 이전하는 애플리케이션 릴리스 모델이다